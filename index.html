<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f14;
      --card:#0f1720;
      --muted:#9aa4b2;
      --accent:#10b981;
      --danger:#ef4444;
    }
    body{background:var(--bg);color:#fff;font-family:Inter,system-ui;}
    .container-app {
  max-width: 1200px;
  margin: 20px auto;
  padding: 10px;
}

.topbar {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto 16px auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
  padding: 12px 20px;
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
}

    /* subbar holding tabs & stats */
.subbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 95%;
  max-width: 1200px;
  margin: 0 auto 20px auto;
  flex-wrap: wrap;
}

/* tabs (left side) */
.tabs {
  display: flex;
  gap: 10px;
}

.tab-btn {
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 8px;
  padding: 6px 14px;
  color: #fff;
  cursor: pointer;
  transition: background 0.2s ease;
}
.tab-btn.active {
  background: var(--accent, #00c896);
  color: #000;
}
.tab-btn:hover {
  background: rgba(255,255,255,0.2);
}

/* stats (right side) */
.stats-container {
  display: flex;
  gap: 12px;
  align-items: center;
}

.stat-card {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  padding: 8px 14px;
  min-width: 110px;
  text-align: center;
  backdrop-filter: blur(8px);
}
.stat-card.low {
  background: rgba(255, 80, 80, 0.1);
  border: 1px solid rgba(255, 80, 80, 0.25);
}
.stat-label {
  font-size: 0.75rem;
  color: var(--muted, #bbb);
}
.stat-value {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--accent, #00ffbb);
}

/* responsive stacking on small screens */
@media (max-width: 768px) {
  .subbar {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  .stats-container {
    align-self: flex-end;
  }
}
.btn-accent{background:var(--accent);color:#fff;border:none;}
.btn-accent:hover{opacity:0.9;}
.grid{display:grid;gap:14px;}
    @media(min-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(min-width:760px) and (max-width:1099px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:759px){.grid{grid-template-columns:repeat(1,1fr)}}
    .card-item{background:var(--card);border-radius:10px;overflow:hidden;position:relative;transition:.2s;}
    .card-item:hover{transform:translateY(-4px);}
    .card-img{width:100%;height:150px;object-fit:cover;}
    .card-body{padding:10px;}
    .small-text{color:var(--muted);font-size:.85rem;}
    .low-stock{box-shadow:0 0 8px 2px rgba(239,68,68,0.4);}
    .img-preview{width:100%;height:160px;object-fit:cover;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,0.1);}
    .toast-container{position:fixed;bottom:16px;right:16px;z-index:9999;}
    .tab-btn {
  background: var(--card);
  color: #fff;
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  padding: 8px 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all .2s ease;
}
.tab-btn.active {
  background: var(--accent);
  color: #fff;
}
.tab-btn:hover {
  background: rgba(255,255,255,0.08);
}
.filter-bar .form-control,
.filter-bar .form-select {
  min-width: 140px;
  font-size: 1rem;
}
@media (max-width: 600px) {
  .filter-bar {
    flex-direction: column !important;
    gap: 10px !important;
    padding: 10px !important;
  }
  .filter-bar .form-control,
  .filter-bar .form-select {
    width: 100% !important;
    max-width: 100% !important;
  }
}
  </style>
</head>

<body>
<div class="container-app">
  <div class="topbar">
    <h2>üì¶ Inventory Dashboard</h2>
    <div class="d-flex gap-2">
    <!-- ‚úÖ Add Item Button -->
<button 
  class="btn btn-accent btn-sm" 
  data-bs-toggle="modal" 
  data-bs-target="#itemModal"
  onclick="resetItemForm()">
  ‚ûï Add Item
</button>

<!-- ‚úÖ Script should be outside the button -->
<script>
function resetItemForm() {
  const fields = ['Item', 'Quantity', 'Unit', 'Category', 'Location', 'Remarks'];
  fields.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });

  // Clear image and file input
  document.getElementById('PictureFile').value = '';
  document.getElementById('imgPreview').src = 'https://via.placeholder.com/200x150?text=No+Image';

  // ‚úÖ Request a new ItemID from Code.gs
  google.script.run.withSuccessHandler(id => {
    document.getElementById('ItemID').value = id;
  }).generateItemID();
}
</script>
<!-- ‚úÖ Script should be outside the button -->
      <button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#shipModal">üöö Record Shipment</button>
    </div>
  </div>
 <!-- Tabs + Stats Row -->
<div class="subbar">
  <div class="tabs mb-3">
    <button id="tabInventory" class="tab-btn active" onclick="showTab('inventory')">üì¶ Inventory</button>
    <button id="tabShipments" class="tab-btn" onclick="showTab('shipments')">üöö Shipments</button>
    <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshAll()">Refresh All</button>
  </div>
    
  <!--////////////////////////////////////////////////////-->
  <!-- üìä Stats Container -->
  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-label">Total Items</div>
      <div class="stat-value" id="statTotalItems">0</div>
    </div>
    <div class="stat-card low">
      <div class="stat-label">Low Stock (&lt; 5)</div>
      <div class="stat-value" id="statLowStock">0</div>
    </div>
  </div> 
</div>

<div id="tabInventoryContent" style="width: 100%; max-width: 1200px; margin: 0 auto;">
  <!-- Improved Filter Controls -->
  <div class="filter-bar d-flex justify-content-center align-items-center gap-3 mb-4 p-3"
       style="background:rgba(255,255,255,0.06);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
    <input type="text" id="searchBox" class="form-control w-auto" style="max-width:220px;" placeholder="üîç Search item..." oninput="applyFilters()">
    <select id="categoryFilter" class="form-select w-auto" style="max-width:180px;" onchange="applyFilters()">
      <option value="All">All Categories</option>
    </select>
    <select id="sortOrder" class="form-select w-auto" style="max-width:220px;" onchange="applyFilters()">
      <option value="asc">‚¨ÜÔ∏è Quantity: Low ‚Üí High</option>
      <option value="desc">‚¨áÔ∏è Quantity: High ‚Üí Low</option>
    </select>
  </div>
  <h5>üì¶ Item List</h5>
  <div id="materialsGrid" class="grid"></div>
</div>

<div id="tabShipmentsContent" style="display:none;">
  <h5>üöö Shipments List</h5>
  <div id="shipmentsGrid" class="grid"></div>
</div>
</div>

<!-- ITEM MODAL -->
<div class="modal fade" id="itemModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3" style="background:var(--card);color:#fff;">
      <h5>Add / Update Item</h5>
      <input id="ItemID" class="form-control form-control-sm mb-2" readonly placeholder="Auto-generated">
      <input id="Item" class="form-control form-control-sm mb-2" placeholder="Item name">
      <input id="Quantity" type="number" class="form-control form-control-sm mb-2" placeholder="Quantity">
      <input id="Unit" class="form-control form-control-sm mb-2" placeholder="Unit (pcs, box...)">
      <input id="Category" class="form-control form-control-sm mb-2" placeholder="Category">
      <input id="Location" class="form-control form-control-sm mb-2" placeholder="Location">
      <input type="file" id="PictureFile" accept="image/*" class="form-control form-control-sm mb-2" onchange="previewImage(event)">
      <img id="imgPreview" class="img-preview">
      <input id="Remarks" class="form-control form-control-sm mb-2" placeholder="Remarks">
      <div class="text-end mt-2">
        <button class="btn btn-accent btn-sm" onclick="saveItem()">Save</button>
        <button class="btn btn-danger btn-sm" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- SHIPMENT MODAL -->
<div class="modal fade" id="shipModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3" style="background:var(--card);color:#fff;">
      <h5>Record Shipment</h5>
      <select id="ShipItem" class="form-select form-select-sm mb-2"></select>
      <input id="ShipQty" type="number" class="form-control form-control-sm mb-2" placeholder="Quantity">
      <input id="ShipUnit" class="form-control form-control-sm mb-2" placeholder="Unit">
      <input id="ShipLocation" class="form-control form-control-sm mb-2" placeholder="Destination">
      <input id="NameReceived" class="form-control form-control-sm mb-2" placeholder="Name Received">

      <!-- üìÖ Date field -->
      <input type="date" id="DateShipped" class="form-control mb-2" placeholder="Date Added">

      <div class="text-end mt-2">
        <button class="btn btn-accent btn-sm" onclick="saveShipment()">Save</button>
        <button class="btn btn-danger btn-sm" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let materials = [];

function loadMaterials(){
  google.script.run.withSuccessHandler(renderMaterials).getMaterials();
}

function renderMaterials(data){
  // Only update global materials if data is from server (full list)
  if (Array.isArray(data) && data.length && data[0].ItemID && (!window.materials || materials.length === 0)) {
    materials = data;
  }
  const grid = document.getElementById('materialsGrid');
  const displayList = (data && data !== materials) ? data : materials;
  if(!displayList.length){
    grid.innerHTML = "<p class='text-center text-muted'>No items found.</p>";
    return;
  }
  grid.innerHTML = displayList.map(m=>{
    const low = Number(m.Quantity)<5 ? 'low-stock' : '';
    return `
    <div class="card-item ${low}">
      <img src="${m.Picture || 'https://via.placeholder.com/300x150?text=No+Image'}" class="card-img">
      <div class="card-body">
        <div class="fw-bold">${m.Item}</div>
        <div class="small-text">${m.Quantity} ${m.Unit} - ${m.Category}</div>
        <div class="small-text">Location: ${m.Location}</div>
        <div class="mt-2 d-flex gap-1">
          <button class="btn btn-sm btn-outline-light" onclick="editItem('${m.ItemID}')">‚úèÔ∏è Edit</button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${m.ItemID}')">üóëÔ∏è Delete</button>
        </div>
      </div>
    </div>`;
  }).join('');
  updateStats(displayList);
  const shipSelect = document.getElementById('ShipItem');
  shipSelect.innerHTML = displayList.map(m=>`<option value="${m.ItemID}">${m.Item}</option>`).join('');
  updateCategoryFilterDropdown(); // <-- Add this line
}

// Add this below your other <script> code

function applyFilters() {
  let filtered = [...materials];

  // Search filter
  const search = document.getElementById('searchBox').value.trim().toLowerCase();
  if (search) {
    filtered = filtered.filter(m =>
      (m.Item || '').toLowerCase().includes(search) ||
      (m.Category || '').toLowerCase().includes(search) ||
      (m.Location || '').toLowerCase().includes(search)
    );
  }

  // Category filter
  const category = document.getElementById('categoryFilter').value;
  if (category && category !== 'All') {
    filtered = filtered.filter(m => m.Category === category);
  }

  // Sort order
  const sortOrder = document.getElementById('sortOrder').value;
  filtered.sort((a, b) => {
    const qA = Number(a.Quantity) || 0;
    const qB = Number(b.Quantity) || 0;
    return sortOrder === 'asc' ? qA - qB : qB - qA;
  });

  // Render filtered grid
  renderMaterials(filtered);

  // Update stats for filtered view
  updateStats(filtered);
}

// Populate category filter dropdown based on materials
function updateCategoryFilterDropdown() {
  const select = document.getElementById('categoryFilter');
  const categories = [...new Set(materials.map(m => m.Category).filter(Boolean))];
  select.innerHTML = `<option value="All">All Categories</option>` +
    categories.map(c => `<option value="${c}">${c}</option>`).join('');
}

function previewImage(event){
  const img = document.getElementById('imgPreview');
  const file = event.target.files[0];
  img.src = file ? URL.createObjectURL(file) : '';
}

function editItem(id){
  const item = materials.find(m=>m.ItemID==id);
  if(!item) return;
  for(const key in item){
    const el = document.getElementById(key);
    if(el) el.value = item[key];
  }
  document.getElementById('imgPreview').src=item.Picture||'';
  new bootstrap.Modal(document.getElementById('itemModal')).show();
}

function saveItem(){
  const file = document.getElementById('PictureFile').files[0];
  const reader = new FileReader();
  reader.onload = function(e){
    const item = {
      ItemID: document.getElementById('ItemID').value || '',
      Item: document.getElementById('Item').value.trim(),
      Quantity: document.getElementById('Quantity').value,
      Unit: document.getElementById('Unit').value,
      Category: document.getElementById('Category').value,
      Location: document.getElementById('Location').value,
      Picture: e.target.result || document.getElementById('imgPreview').src,
      Remarks: document.getElementById('Remarks').value
    };
    google.script.run.withSuccessHandler(res=>{
      showToast(res.success ? '‚úÖ Saved successfully!' : '‚ùå Failed to save item.');
      if(res.success){
        bootstrap.Modal.getInstance(document.getElementById('itemModal')).hide();
        loadMaterials();
      }
    }).saveItem(item);
  };
  if(file) reader.readAsDataURL(file);
  else reader.onload({target:{result:document.getElementById('imgPreview').src}});
}

function populateShipmentDropdown() {
  const select = document.getElementById('ShipItem');
  select.innerHTML = materials.map(m => 
    `<option value="${m.ItemID}">${m.Item} (${m.Quantity} ${m.Unit})</option>`
  ).join('');
}

// Open shipment modal
function openShipmentModal() {
  populateShipmentDropdown();
  new bootstrap.Modal(document.getElementById('shipModal')).show();
}

function saveShipment() {
  const ship = {
    ShipItem: document.getElementById('ShipItem').value,      // ItemID reference
    ShipQty: document.getElementById('ShipQty').value.trim(),
    ShipUnit: document.getElementById('ShipUnit').value.trim(),
    ShipLocation: document.getElementById('ShipLocation').value.trim(),
    NameReceived: document.getElementById('NameReceived').value.trim(),
    DateShipped: document.getElementById('DateShipped').value.trim()
  };

  if (!ship.ShipItem || !ship.ShipQty || !ship.ShipUnit || !ship.ShipLocation || !ship.NameReceived || !ship.DateShipped) {
    showToast("‚ö†Ô∏è Please complete all fields before saving.");
    return;
  }

  google.script.run
    .withSuccessHandler(res => {
      if (res.success) {
        showToast("‚úÖ Shipment recorded successfully!");
        bootstrap.Modal.getInstance(document.getElementById('shipModal')).hide();
        loadMaterials(); // Refresh grid and quantities
      } else {
        showToast("‚ùå Failed to record shipment: " + (res.message || 'Unknown error.'));
      }
    })
    .saveShipment(ship);
}

function deleteItem(id){
  if(!confirm('Are you sure you want to delete this item?')) return;
  google.script.run.withSuccessHandler(res=>{
    showToast(res.success ? 'üóëÔ∏è Item deleted successfully.' : '‚ùå Failed to delete item.');
    if(res.success) loadMaterials();
  }).deleteItem(id);
}

function showToast(msg){
  const container=document.getElementById('toastContainer');
  const toast=document.createElement('div');
  toast.className='toast align-items-center text-bg-dark border-0 show mb-2';
  toast.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  container.appendChild(toast);
  setTimeout(()=>toast.remove(),4000);
}

function showTab(tab) {
  const invBtn = document.getElementById('tabInventory');
  const shipBtn = document.getElementById('tabShipments');
  const invContent = document.getElementById('tabInventoryContent');
  const shipContent = document.getElementById('tabShipmentsContent');

  if (tab === 'inventory') {
    invContent.style.display = 'block';
    shipContent.style.display = 'none';
    invBtn.classList.add('active');
    shipBtn.classList.remove('active');
  } else {
    invContent.style.display = 'none';
    shipContent.style.display = 'block';
    invBtn.classList.remove('active');
    shipBtn.classList.add('active');
    loadShipments();
  }
}

function loadShipments() {
  google.script.run
    .withSuccessHandler(({ shipments, inventory }) => {
      renderShipments(shipments, inventory);
    })
    .getShipmentsWithInventory();
}

// Renders shipments with image support
function renderShipments(data, inventory) {
  const grid = document.getElementById('shipmentsGrid');
  if (!grid) {
    console.error('shipmentsGrid element not found');
    return;
  }

  const shipments = data || [];

  if (!shipments.length) {
    grid.innerHTML = "<p class='text-center text-muted'>No shipments recorded yet.</p>";
    return;
  }

  grid.innerHTML = shipments.map(s => {
    const inv = inventory?.find(i => i.ItemID == s.ShipItem);
    const itemName = inv ? inv.Item : (s.Item || 'Unknown Item');
    const img = inv?.Picture || 'https://via.placeholder.com/300x150?text=No+Image';
    const date = s.DateShipped
      ? new Date(s.DateShipped).toLocaleDateString()
      : 'No date';

    return `
      <div class="card-item">
        <img src="${img}" class="card-img">
        <div class="card-body">
          <div class="fw-bold">${itemName}</div>
          <div class="small-text">${s.ShipQty} ${s.ShipUnit}</div>
          <div class="small-text">üìç ${s.ShipLocation}</div>
          <div class="small-text">üë§ ${s.NameReceived}</div>
          <div class="small-text" style="color:red;">üÜî ${s.ShippedID} | üìÖ ${date}</div>
        </div>
      </div>
    `;
  }).join('');
}

function updateStats(inventory) {
  const totalItems = inventory.length;
  const lowStock = inventory.filter(i => Number(i.Quantity) < 5).length;

  document.getElementById('statTotalItems').textContent = totalItems;
  document.getElementById('statLowStock').textContent = lowStock;
}


window.onload = loadMaterials;

// Listen for clear/search input and reset grid if search is empty
document.getElementById('searchBox').addEventListener('input', function() {
  if (this.value.trim() === '') {
    renderMaterials(materials); // Always use the full list
    updateStats(materials);
  }
});

function refreshAll() {
  loadMaterials(); // Reloads all items from server
  document.getElementById('searchBox').value = '';
  document.getElementById('categoryFilter').value = 'All';
  document.getElementById('sortOrder').value = 'asc';
  showToast("üîÉ Refreshed all items!");
}
</script>
</body>
</html>
